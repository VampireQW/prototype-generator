# 功能详解 (Feature Details)

## 1. 预览器 (Viewer)

`viewer.html` 是系统的核心交互界面，支持四种工作模式：

| 模式 | 标识颜色 | 功能描述 |
|------|-----------|----------|
| **预览模式** | 🟢 绿色 | 沉浸式预览，隐藏所有侧边栏，模拟真实用户体验 |
| **编辑模式** | 🔵 蓝色 | 侧边栏撰写 PRD 文档，支持实时 Markdown 预览 |
| **研发模式** | 🟠 橙色 | 显示页面导航、流程图，PRD 只读查看，适合研发人员 |
| **微调模式** | 🟣 粉色 | AI 辅助微调，支持点选/框选元素进行修改 |

---

## 2. 项目管理

左侧项目列表提供完整的项目管理功能：

| 操作 | 图标 | 说明 |
|------|------|------|
| 编辑标题 | ✏️ | 修改项目名称（同步重命名文件夹） |
| **复制项目** | 📋 | 一键复制整个项目到新名称 |
| 预览 | 👁️ | 在新标签页打开预览器 |
| 查看记录 | 📜 | 查看生成时的配置和参考图 |
| 删除 | 🗑️ | 移动到回收站（可恢复） |

### 项目状态显示

项目列表支持显示项目生成状态：

| 状态 | 图标 | 说明 |
|------|------|------|
| 生成中 | 🔵 转圈动画 | AI正在异步生成中 |
| 失败 | 🔴 感叹号 | 生成过程出错 |
| 待外部生成 | 🟡 时钟 | 已复制Prompt，等待外部工具生成 |

### 复制 Prompt 功能

**位置**：主界面顶部的「复制 Prompt」按钮（绿色）

**功能**：将设计需求复制到剪贴板，用于 Antigravity、Cursor、Claude 等外部 AI 工具。

**工作流程**：
1. 填写设计需求和上传参考图
2. 点击「复制 Prompt」
3. 自动创建占位项目（状态：待外部生成）
4. Prompt 和参考图已复制/保存
5. 在外部工具中生成 HTML
6. 将 HTML 保存到项目文件夹的 `index.html`
7. 刷新即可预览

---

## 3. 微调模式 (Inspector Mode)

微调模式提供"指哪改哪"的可视化修改能力。

### 交互方式
- **点选**：单击高亮选中单个 DOM 元素。
- **框选**：拖拽绘制矩形框，批量选中区域内元素。
- **追加**：按住 `Ctrl/Cmd` 点击，追加或取消选中。

### 技术原理
1. **覆盖层 (Overlay)**：在 iframe 上方覆盖透明 div (`#inspectorOverlay`) 捕获鼠标事件。
2. **坐标映射**：将主窗口的鼠标/选框坐标转换为 iframe 内部的相对坐标。
3. **元素查找**：使用 `document.elementsFromPoint` 或遍历 DOM 判断矩形相交。
4. **Prompt 生成**：自动提取选中元素的 Tag、CSS Selector 和 HTML 片段。

### API 流程
1. 前端发送 `projectId` + `selector` + `html` + `userRequest` 给后端。
2. 后端 `/api/inspector/apply` 读取当前 HTML。
3. 组装 AI Prompt，调用大模型修改指定元素。
4. 后端备份原文件 (`.bak`)，覆写新 HTML。
5. 前端收到成功响应后刷新 iframe。

### 提示词结构 (2026-02-05 优化)

元素微调提示词现包含以下信息，便于 AI IDE 精确定位：

| 字段 | 说明 |
|------|------|
| 目标文件路径 | 完整绝对路径，可直接打开 |
| 项目ID | 项目文件夹名称 |
| 当前页面 | hash / Vue 路由信息 |
| 元素 CSS 选择器 | 定位元素 |
| 元素 ID/class | 便于搜索 |
| 文本内容 | 前50字符 |
| HTML 片段 | 精确匹配 |

### 整页面修改 (2026-02-05 新增)

底部提示条新增紫色「整页面」按钮：
- 支持针对整个页面的修改需求
- 自动包含目标文件路径和当前页面信息
- 弹窗可拖动

---

## 4. PRD 撰写系统

PRD (需求文档) 以 Markdown 形式存储在 `projects/{id}/prd/{pageName}.md`。

- **编辑器**：原生 `<textarea>` + `postMessage` 实时保存。
- **渲染**：使用 `marked.js` 前端渲染。
- **关联**：文档与当前浏览的页面自动绑定。

---

## 5. 项目导出

通过 `export_project.py` (或 `导出项目.bat`) 将项目打包。

### 导出模式
1. **完整导出**：包含 viewer、研发模式、流程图、PRD。
2. **纯预览导出**：仅包含 `index.html` 和资源，适合非技术人员查看。

### 关键技术：零依赖
导出后的项目**无需 Python 环境**，双击 HTML 即可运行。通过在导出时注入 JS 监听器，解决了 `file://` 协议下的跨域通信问题。


### 📝 最近更新 (2026-01-30)
- 添加输入验证：AI生成和复制Prompt按钮在无输入时显示提示
- 测试自动文档更新功能 - SKILL优化测试
