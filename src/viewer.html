<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>原型预览器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Marked.js for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Mermaid.js for flowchart -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .scrollbar-thin::-webkit-scrollbar {
            width: 6px;
        }

        .scrollbar-thin::-webkit-scrollbar-track {
            background: transparent;
        }

        .scrollbar-thin::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        /* PRD 侧边栏动画 */
        .prd-sidebar {
            transition: width 0.3s ease;
            position: relative;
        }

        .prd-sidebar.collapsed {
            width: 48px;
        }

        .prd-sidebar.expanded {
            width: 420px;
        }

        /* Markdown 样式 */
        .markdown-body h1 {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 1rem 0 0.5rem;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 0.5rem;
        }

        .markdown-body h2 {
            font-size: 1.25rem;
            font-weight: 600;
            margin: 1rem 0 0.5rem;
        }

        .markdown-body h3 {
            font-size: 1.1rem;
            font-weight: 600;
            margin: 0.75rem 0 0.5rem;
        }

        .markdown-body p {
            margin: 0.5rem 0;
            line-height: 1.6;
        }

        .markdown-body ul {
            margin: 0.5rem 0;
            padding-left: 1.5rem;
            list-style-type: disc;
        }

        .markdown-body ol {
            margin: 0.5rem 0;
            padding-left: 1.5rem;
            list-style-type: decimal;
        }

        .markdown-body li {
            margin: 0.25rem 0;
            display: list-item;
        }

        .markdown-body code {
            background: #f3f4f6;
            padding: 0.125rem 0.375rem;
            border-radius: 4px;
            font-size: 0.875rem;
        }

        .markdown-body pre {
            background: #1f2937;
            color: #e5e7eb;
            padding: 1rem;
            border-radius: 8px;
            overflow-x: auto;
            margin: 0.75rem 0;
        }

        .markdown-body pre code {
            background: transparent;
            padding: 0;
            color: inherit;
        }

        .markdown-body blockquote {
            border-left: 4px solid #6366f1;
            padding-left: 1rem;
            margin: 0.75rem 0;
            color: #6b7280;
        }

        .markdown-body table {
            width: 100%;
            border-collapse: collapse;
            margin: 0.75rem 0;
        }

        .markdown-body th,
        .markdown-body td {
            border: 1px solid #e5e7eb;
            padding: 0.5rem;
            text-align: left;
        }

        .markdown-body th {
            background: #f9fafb;
            font-weight: 600;
        }

        /* 页面列表样式 */
        .page-item {
            transition: all 0.2s ease;
        }

        .page-item:hover {
            background: #f3f4f6;
        }

        .page-item.active {
            background: #eef2ff;
            border-left: 3px solid #6366f1;
        }

        /* 模式切换按钮 */
        .mode-toggle {
            transition: all 0.2s ease;
        }

        .mode-toggle.active {
            background: #6366f1;
            color: white;
        }

        /* 模式切换器容器 - 收起状态 */
        .mode-switcher {
            position: relative;
        }

        .mode-switcher-trigger {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: #f3f4f6;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .mode-switcher-trigger:hover {
            background: #e5e7eb;
        }

        .mode-switcher-trigger i:first-child {
            width: 16px;
            text-align: center;
        }

        .mode-switcher-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px -5px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(0, 0, 0, 0.05);
            opacity: 0;
            visibility: hidden;
            transform: translateY(-8px);
            transition: all 0.2s ease;
            z-index: 100;
            min-width: 180px;
            padding: 8px;
        }

        .mode-switcher:hover .mode-switcher-dropdown {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .mode-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .mode-option:hover {
            background: #f3f4f6;
        }

        .mode-option.active {
            background: #eef2ff;
        }

        .mode-option .mode-icon {
            width: 32px;
            height: 32px;
            min-width: 32px;
            flex-shrink: 0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .mode-option.preview-mode .mode-icon {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .mode-option.edit-mode .mode-icon {
            background: linear-gradient(135deg, #6366f1, #4f46e5);
            color: white;
        }

        .mode-option.dev-mode .mode-icon {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }

        .mode-option .mode-info {
            flex: 1;
        }

        .mode-option .mode-name {
            font-weight: 600;
            font-size: 13px;
            color: #1f2937;
        }

        .mode-option .mode-desc {
            font-size: 11px;
            color: #6b7280;
            white-space: nowrap;
        }

        .mode-option .mode-check {
            color: #6366f1;
            opacity: 0;
        }

        .mode-option.active .mode-check {
            opacity: 1;
        }

        /* 预览容器自适应 */
        .preview-frame-mobile {
            width: 390px;
            height: 844px;
            border-radius: 40px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        /* App 模式下隐藏 iframe 滚动条 */
        .preview-frame-mobile iframe {
            scrollbar-width: none;
            /* Firefox */
            -ms-overflow-style: none;
            /* IE/Edge */
        }

        .preview-frame-mobile iframe::-webkit-scrollbar {
            display: none;
            /* Chrome/Safari */
        }

        .preview-frame-web {
            width: 100%;
            height: 100%;
            border-radius: 0;
            box-shadow: none;
        }

        /* ==================== iPhone 真机外壳 ==================== */
        .device-frame {
            position: relative;
            width: 402px;
            height: 868px;
            background: linear-gradient(145deg, #3a3a40, #2a2a30);
            border-radius: 56px;
            padding: 10px;
            box-shadow:
                inset 0 0 0 1.5px rgba(255, 255, 255, 0.08),
                0 0 0 1px #1a1a20,
                0 0 0 2.5px #3a3a42,
                0 0 0 3.5px #1a1a20,
                0 30px 70px -10px rgba(0, 0, 0, 0.5),
                0 15px 30px -8px rgba(0, 0, 0, 0.3);
        }

        /* 右侧按钮 - 电源键（凸出写实） */
        .device-frame::before {
            content: '';
            position: absolute;
            right: -4px;
            top: 200px;
            width: 4px;
            height: 72px;
            background: linear-gradient(to right, #2a2a2e, #1a1a1e, #2a2a2e);
            border-radius: 0 3px 3px 0;
            box-shadow:
                1px 0 1px rgba(255, 255, 255, 0.08),
                2px 0 3px rgba(0, 0, 0, 0.4),
                inset -1px 0 1px rgba(255, 255, 255, 0.06),
                inset 0 1px 1px rgba(255, 255, 255, 0.04),
                inset 0 -1px 1px rgba(0, 0, 0, 0.2);
        }

        /* 左侧按钮 - 静音+音量上+音量下（凸出写实） */
        .device-frame::after {
            content: '';
            position: absolute;
            left: -4px;
            top: 148px;
            width: 4px;
            height: 28px;
            background: linear-gradient(to left, #2a2a2e, #1a1a1e, #2a2a2e);
            border-radius: 3px 0 0 3px;
            box-shadow:
                -1px 0 1px rgba(255, 255, 255, 0.08),
                -2px 0 3px rgba(0, 0, 0, 0.4),
                inset 1px 0 1px rgba(255, 255, 255, 0.06),
                inset 0 1px 1px rgba(255, 255, 255, 0.04),
                inset 0 -1px 1px rgba(0, 0, 0, 0.2),
                0 42px 0 0 #222226,
                -1px 42px 1px rgba(255, 255, 255, 0.08),
                -2px 42px 3px rgba(0, 0, 0, 0.4),
                0 82px 0 0 #222226,
                -1px 82px 1px rgba(255, 255, 255, 0.08),
                -2px 82px 3px rgba(0, 0, 0, 0.4);
        }

        .device-screen {
            position: relative;
            width: 100%;
            height: 100%;
            border-radius: 46px;
            overflow: hidden;
            background: #000;
        }

        /* iOS 状态栏 - 不透明背景 */
        .device-status-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 54px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 28px;
            z-index: 20;
            pointer-events: none;
            background: #fff;
        }

        .status-time {
            font-family: -apple-system, 'SF Pro Text', 'Helvetica Neue', sans-serif;
            font-size: 15px;
            font-weight: 600;
            color: #000;
            letter-spacing: 0.5px;
            min-width: 54px;
        }

        .status-icons {
            display: flex;
            align-items: center;
            gap: 5px;
            min-width: 72px;
            justify-content: flex-end;
        }

        .status-icons svg {
            fill: #000;
        }

        /* Dynamic Island */
        .device-notch {
            position: absolute;
            top: 11px;
            left: 50%;
            transform: translateX(-50%);
            width: 126px;
            height: 36px;
            background: #000;
            border-radius: 20px;
            z-index: 30;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 14px;
        }

        .device-notch::before {
            content: '';
            width: 12px;
            height: 12px;
            background: radial-gradient(circle at 40% 40%, #1e3a5f 0%, #0d1b2a 50%, #050510 100%);
            border-radius: 50%;
            box-shadow: inset 0 0.5px 1px rgba(255, 255, 255, 0.15);
        }

        .device-screen iframe {
            width: 100%;
            height: 100%;
            border: 0;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .device-screen iframe::-webkit-scrollbar {
            display: none;
        }

        /* Home indicator bar */
        .device-home-bar {
            position: absolute;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
            width: 134px;
            height: 5px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 3px;
            z-index: 20;
        }

        /* 外壳模式开关样式 */
        .device-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #6b7280;
            cursor: pointer;
            padding: 4px 0;
            user-select: none;
        }

        .device-toggle input[type="checkbox"] {
            width: 34px;
            height: 18px;
            appearance: none;
            -webkit-appearance: none;
            background: #d1d5db;
            border-radius: 18px;
            position: relative;
            cursor: pointer;
            transition: background 0.2s;
            flex-shrink: 0;
        }

        .device-toggle input[type="checkbox"]::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 14px;
            height: 14px;
            background: white;
            border-radius: 50%;
            transition: transform 0.2s;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .device-toggle input[type="checkbox"]:checked {
            background: #6366f1;
        }

        .device-toggle input[type="checkbox"]:checked::after {
            transform: translateX(16px);
        }

        /* 隐藏 PRD 侧边栏（预览模式） */
        .prd-sidebar.hidden-mode {
            display: none !important;
        }

        /* 预览模式悬浮工具栏 - 精简版 */
        .preview-toolbar-wrapper {
            position: fixed;
            top: 6px;
            right: 6px;
            z-index: 1000;
        }

        /* 小图标触发器 */
        .preview-toolbar-trigger {
            width: 32px;
            height: 32px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(0, 0, 0, 0.08);
            border-radius: 8px;
            /* Slightly smaller radius */
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: move;
            /* Move cursor */
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
            user-select: none;
        }

        .preview-toolbar-trigger:hover {
            background: #fff;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        }

        .preview-toolbar-trigger i {
            color: #6366f1;
            font-size: 14px;
            /* Smaller icon */
        }

        /* 展开的工具栏面板 */
        .preview-toolbar-panel {
            position: absolute;
            top: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(0, 0, 0, 0.08);
            border-radius: 12px;
            padding: 12px 16px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.15);
            display: none;
            flex-direction: column;
            gap: 12px;
            min-width: 160px;
        }

        /* Class-based toggle for JS control */
        .preview-toolbar-wrapper.expanded .preview-toolbar-trigger {
            display: none;
        }

        .preview-toolbar-wrapper.expanded .preview-toolbar-panel {
            display: flex;
        }

        /* 精简视图选择器 */
        .compact-view-selector {
            display: flex;
            gap: 6px;
        }

        .compact-view-selector .view-btn {
            padding: 6px 10px;
            font-size: 12px;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
            background: #fff;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .compact-view-selector .view-btn:hover {
            border-color: #6366f1;
            color: #6366f1;
        }

        .compact-view-selector .view-btn.active {
            background: #6366f1;
            border-color: #6366f1;
            color: #fff;
        }

        /* 模式切换按钮 - 精简 */
        .compact-mode-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .compact-mode-btn:hover {
            background: #f3f4f6;
        }

        .compact-mode-btn i {
            font-size: 14px;
        }

        .compact-mode-btn span {
            font-size: 13px;
            font-weight: 500;
        }

        /* 隐藏原 header（预览模式） */
        .header-floating {
            display: none !important;
        }

        /* 预览模式下主内容区域全屏 */
        body.preview-fullscreen .main-container {
            padding-top: 0 !important;
        }

        body.preview-fullscreen #previewContainer {
            padding: 16px;
        }

        body.preview-fullscreen #previewContainer.web-mode {
            padding: 0;
        }

        /* ==================== 微调模式 (Inspector) 样式 ==================== */

        /* 微调模式按钮颜色 */
        .mode-option.inspector-mode .mode-icon {
            background: linear-gradient(135deg, #ec4899, #db2777);
            color: white;
        }

        /* 元素高亮效果（悬停时） */
        .inspector-highlight {
            outline: 2px solid #ec4899 !important;
            outline-offset: 2px;
            background-color: rgba(236, 72, 153, 0.1) !important;
        }

        /* 元素选中效果 */
        .inspector-selected {
            outline: 3px solid #ec4899 !important;
            outline-offset: 2px;
            background-color: rgba(236, 72, 153, 0.15) !important;
        }

        /* Inspector 覆盖层 */
        #inspectorOverlay {
            position: absolute;
            inset: 0;
            z-index: 50;
            cursor: crosshair;
            pointer-events: none;
        }

        #inspectorOverlay.active {
            pointer-events: auto;
        }

        /* 框选选择框 */
        #selectionBox {
            position: absolute;
            border: 2px dashed #ec4899;
            background-color: rgba(236, 72, 153, 0.1);
            pointer-events: none;
        }

        /* 微调弹窗 */
        #inspectorModal {
            position: fixed;
            inset: auto;
            bottom: 20px;
            right: 20px;
            width: 320px;
            max-width: 90vw;
            height: auto;
            max-height: 80vh;
            background: transparent;
            display: none;
            z-index: 2000;
            pointer-events: none;
            /* Allow clicking through background */
        }

        #inspectorModal.active {
            display: flex;
            flex-direction: column;
        }

        #inspectorModal.hidden {
            display: none !important;
        }

        .inspector-modal-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid #e5e7eb;
            pointer-events: auto;
            /* Enable interaction with content */
        }

        .inspector-modal-header {
            padding: 12px 16px;
            border-bottom: 1px solid #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: move;
            user-select: none;
        }

        .inspector-modal-body {
            padding: 16px 20px;
        }

        .inspector-modal-footer {
            padding: 16px 20px;
            border-top: 1px solid #f3f4f6;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        /* 选中元素预览区 */
        .selected-elements-preview {
            max-height: 150px;
            overflow-y: auto;
            background: #f9fafb;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
            font-size: 12px;
            font-family: 'Monaco', 'Menlo', monospace;
        }

        .selected-element-item {
            padding: 8px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .selected-element-item:last-child {
            margin-bottom: 0;
        }

        .selected-element-tag {
            color: #ec4899;
            font-weight: 600;
        }

        .selected-element-selector {
            color: #6b7280;
            font-size: 11px;
            margin-top: 4px;
        }

        .selected-element-html {
            color: #374151;
            margin-top: 6px;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 60px;
            overflow: hidden;
        }

        /* 微调输入框 */
        #inspectorInput {
            width: 100%;
            height: 100px;
            padding: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            resize: none;
            font-size: 14px;
            line-height: 1.5;
        }

        #inspectorInput:focus {
            outline: none;
            border-color: #ec4899;
            box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.1);
        }

        /* 微调按钮样式 */
        .inspector-btn {
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.15s ease;
        }

        .inspector-btn-secondary {
            background: #f3f4f6;
            color: #374151;
            border: none;
        }

        .inspector-btn-secondary:hover {
            background: #e5e7eb;
        }

        .inspector-btn-primary {
            background: linear-gradient(135deg, #ec4899, #db2777);
            color: white;
            border: none;
        }

        .inspector-btn-primary:hover {
            background: linear-gradient(135deg, #db2777, #be185d);
        }

        /* 微调模式激活提示 */
        .inspector-mode-hint {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 24px;
            border-radius: 100px;
            font-size: 14px;
            z-index: 1001;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .inspector-mode-hint kbd {
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
        }

        /* 整页面按钮 */
        .fullpage-btn {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            border: none;
            padding: 6px 14px;
            border-radius: 100px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            margin-left: 12px;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .fullpage-btn:hover {
            background: linear-gradient(135deg, #7c3aed, #6d28d9);
            transform: scale(1.02);
        }

        /* 整页面弹窗样式复用 inspector 弹窗 */
        #fullPageModal {
            position: fixed;
            inset: auto;
            bottom: 20px;
            right: 20px;
            width: 360px;
            max-width: 90vw;
            height: auto;
            max-height: 80vh;
            background: transparent;
            display: none;
            z-index: 2000;
            pointer-events: none;
        }

        #fullPageModal.active {
            display: flex;
            flex-direction: column;
        }

        .fullpage-info {
            background: #f3f0ff;
            border: 1px solid #ddd6fe;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
            font-size: 13px;
            color: #5b21b6;
        }

        .fullpage-info strong {
            color: #7c3aed;
        }

        /* 整页面输入框样式 */
        #fullPageInput {
            width: 100%;
            height: 100px;
            padding: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            resize: none;
            font-size: 14px;
            line-height: 1.5;
            box-sizing: border-box;
        }

        #fullPageInput:focus {
            outline: none;
            border-color: #8b5cf6;
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }

        /* Toast 提示样式 */
        .toast-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            pointer-events: none;
        }

        .toast {
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 8px;
            opacity: 0;
            transform: translateY(-20px);
            animation: toastIn 0.3s ease forwards;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .toast.success {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .toast.error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .toast.warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .toast.hide {
            animation: toastOut 0.3s ease forwards;
        }

        @keyframes toastIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes toastOut {
            to {
                opacity: 0;
                transform: translateY(-20px);
            }
        }
    </style>
</head>

<body class="bg-gray-100 h-screen flex flex-col overflow-hidden">
    <!-- 预览模式悬浮工具栏 -->
    <div id="previewToolbar" class="preview-toolbar-wrapper">
        <!-- 小图标触发器 -->
        <div class="preview-toolbar-trigger">
            <i class="fas fa-cog"></i>
        </div>
        <!-- 展开面板 -->
        <div class="preview-toolbar-panel">
            <!-- 视图选择 -->
            <div>
                <div class="text-xs text-gray-400 mb-2">视图</div>
                <div class="compact-view-selector" id="floatingViewSelector">
                    <button class="view-btn active" data-view="auto">Auto</button>
                    <button class="view-btn" data-view="web">Web</button>
                    <button class="view-btn" data-view="mobile">App</button>
                </div>
            </div>
            <!-- 真机外壳开关 -->
            <div id="floatingDeviceToggle" style="display: none;">
                <div class="text-xs text-gray-400 mb-2">外壳</div>
                <label class="device-toggle">
                    <input type="checkbox" id="floatingDeviceFrameToggle" checked
                        onchange="toggleDeviceFrame(this.checked)">
                    <span>显示真机外壳</span>
                </label>
            </div>
            <!-- 模式切换 -->
            <div>
                <div class="text-xs text-gray-400 mb-2">模式</div>
                <div class="compact-mode-btn" data-mode="preview" onclick="switchMode('preview')"
                    style="color: #10b981;">
                    <i class="fas fa-eye"></i>
                    <span>预览模式</span>
                    <i class="fas fa-check text-xs ml-auto mode-check"></i>
                </div>
                <div class="compact-mode-btn" data-mode="edit" onclick="switchMode('edit')" style="color: #6366f1;">
                    <i class="fas fa-edit"></i>
                    <span>编辑模式</span>
                    <i class="fas fa-check text-xs ml-auto mode-check" style="display: none;"></i>
                </div>
                <div class="compact-mode-btn" data-mode="dev" onclick="switchMode('dev')" style="color: #f59e0b;">
                    <i class="fas fa-code"></i>
                    <span>研发模式</span>
                    <i class="fas fa-check text-xs ml-auto mode-check" style="display: none;"></i>
                </div>
                <div class="compact-mode-btn" data-mode="inspector" onclick="switchMode('inspector')"
                    style="color: #ec4899;">
                    <i class="fas fa-crosshairs"></i>
                    <span>微调模式</span>
                    <i class="fas fa-check text-xs ml-auto mode-check" style="display: none;"></i>
                </div>
            </div>
            <!-- 返回按钮 -->
            <div style="border-top: 1px solid #e5e7eb; margin-top: 8px; padding-top: 8px;">
                <a href="index.html" class="compact-mode-btn" style="color: #6b7280; text-decoration: none;">
                    <i class="fas fa-arrow-left"></i>
                    <span>返回首页</span>
                </a>
            </div>
        </div>
    </div>

    <!-- 顶部工具栏 (非预览模式) -->
    <header id="mainHeader" style="display: none;"
        class="bg-white border-b border-gray-200 h-14 flex items-center justify-between px-6 flex-none z-20">
        <div class="header-left flex items-center gap-4">
            <a href="index.html" class="text-gray-500 hover:text-gray-700 flex items-center gap-2">
                <i class="fas fa-arrow-left"></i>
                <span class="text-sm">返回</span>
            </a>
            <div class="h-6 w-px bg-gray-200"></div>
            <h1 id="projectTitle" class="font-bold text-gray-900">项目预览</h1>
        </div>

        <div class="header-right flex items-center gap-4">
            <!-- 视图选择 (统一按钮样式) -->
            <div class="flex items-center gap-2">
                <span class="text-xs text-gray-400">视图</span>
                <div class="compact-view-selector" id="headerViewSelector">
                    <button class="view-btn active" data-view="auto">Auto</button>
                    <button class="view-btn" data-view="web">Web</button>
                    <button class="view-btn" data-view="mobile">App</button>
                </div>
            </div>

            <div class="h-6 w-px bg-gray-200"></div>

            <!-- 模式切换器 -->
            <div class="mode-switcher">
                <div class="mode-switcher-trigger">
                    <i id="currentModeIcon" class="fas fa-eye text-green-600"></i>
                    <span id="currentModeName" class="text-sm font-medium text-gray-700">预览模式</span>
                    <i class="fas fa-chevron-down text-xs text-gray-400"></i>
                </div>
                <div class="mode-switcher-dropdown">
                    <div class="mode-option preview-mode active" onclick="switchMode('preview')">
                        <div class="mode-icon"><i class="fas fa-eye"></i></div>
                        <div class="mode-info">
                            <div class="mode-name">预览模式</div>
                            <div class="mode-desc">纯净预览</div>
                        </div>
                        <i class="fas fa-check mode-check"></i>
                    </div>
                    <div class="mode-option edit-mode" onclick="switchMode('edit')">
                        <div class="mode-icon"><i class="fas fa-edit"></i></div>
                        <div class="mode-info">
                            <div class="mode-name">编辑模式</div>
                            <div class="mode-desc">编辑 PRD</div>
                        </div>
                        <i class="fas fa-check mode-check"></i>
                    </div>
                    <div class="mode-option dev-mode" onclick="switchMode('dev')">
                        <div class="mode-icon"><i class="fas fa-code"></i></div>
                        <div class="mode-info">
                            <div class="mode-name">研发模式</div>
                            <div class="mode-desc">页面导航 + PRD</div>
                        </div>
                        <i class="fas fa-check mode-check"></i>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- 主内容区 -->
    <div class="flex-1 flex overflow-hidden">
        <!-- 左侧边栏 (编辑/研发模式) -->
        <aside id="devSidebar" class="bg-white border-r border-gray-200 flex-col hidden relative"
            style="transition: width 0.2s ease;">
            <!-- 展开/收起按钮 -->
            <button id="devSidebarToggle" onclick="toggleDevSidebar()"
                class="absolute top-1/2 right-0 w-4 h-12 bg-gray-400 hover:bg-gray-500 text-white rounded-r-md flex items-center justify-center cursor-pointer z-20 shadow-sm"
                style="transform: translateX(100%) translateY(-50%);">
                <i class="fas fa-chevron-right" style="font-size: 9px;"></i>
            </button>

            <!-- 收起时的竖向标签 -->
            <div id="devSidebarCollapsedLabel"
                class="flex-1 flex items-center justify-center cursor-pointer hover:bg-gray-50"
                onclick="toggleDevSidebar()" style="width: 28px;">
                <span class="text-gray-500 text-xs font-medium"
                    style="writing-mode: vertical-lr; transform: rotate(180deg);">页面</span>
            </div>

            <!-- 展开时的内容 -->
            <div id="devSidebarContent" class="flex-col hidden overflow-hidden" style="width: 256px;">
                <div class="p-4 border-b border-gray-100">
                    <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider">页面导航</h3>
                </div>

                <!-- 流程图入口 -->
                <div id="flowchartEntry"
                    class="p-3 border-b border-gray-100 cursor-pointer hover:bg-indigo-50 transition-colors">
                    <div class="flex items-center gap-3 text-indigo-600">
                        <i class="fas fa-project-diagram"></i>
                        <span class="font-medium">页面流程图</span>
                    </div>
                </div>

                <!-- 页面列表 -->
                <div id="pageList" class="flex-1 overflow-y-auto scrollbar-thin">
                    <div class="p-4 text-center text-gray-400 text-sm">加载中...</div>
                </div>
            </div>
        </aside>

        <!-- 中间预览区 -->
        <main class="flex-1 flex flex-col min-w-0 overflow-hidden bg-gray-200">
            <!-- 流程图视图 -->
            <div id="flowchartView" class="flex-1 bg-white m-4 rounded-xl shadow-sm overflow-auto hidden">
                <div class="p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <i class="fas fa-project-diagram text-indigo-500"></i>
                        页面流程图
                    </h2>
                    <div id="flowchartContainer" class="min-h-[400px]"></div>
                </div>
            </div>

            <!-- iframe 预览 -->
            <div id="previewContainer" class="flex-1 flex items-center justify-center p-4 relative">
                <!-- 带外壳的预览 -->
                <div id="deviceFrameWrapper" class="device-frame">
                    <div class="device-screen">
                        <!-- Dynamic Island -->
                        <div class="device-notch"></div>
                        <!-- iOS 状态栏 -->
                        <div class="device-status-bar">
                            <span class="status-time">12:00</span>
                            <div class="status-icons">
                                <!-- Signal bars -->
                                <svg width="17" height="12" viewBox="0 0 17 12">
                                    <rect x="0" y="9" width="3" height="3" rx="0.5" />
                                    <rect x="4.5" y="6" width="3" height="6" rx="0.5" />
                                    <rect x="9" y="3" width="3" height="9" rx="0.5" />
                                    <rect x="13.5" y="0" width="3" height="12" rx="0.5" />
                                </svg>
                                <!-- WiFi -->
                                <svg width="16" height="12" viewBox="0 0 16 12">
                                    <path d="M8 9.6a1.6 1.6 0 110 3.2 1.6 1.6 0 010-3.2zM3.6 7.2a6.2 6.2 0 018.8 0"
                                        fill="none" stroke="#000" stroke-width="1.5" stroke-linecap="round" />
                                    <path d="M1 4.2a10 10 0 0114 0" fill="none" stroke="#000" stroke-width="1.5"
                                        stroke-linecap="round" />
                                </svg>
                                <!-- Battery -->
                                <svg width="27" height="12" viewBox="0 0 27 12">
                                    <rect x="0" y="0.5" width="23" height="11" rx="2.5" fill="none" stroke="#000"
                                        stroke-width="1" />
                                    <rect x="24" y="3.5" width="2.5" height="4" rx="1" fill="#000" opacity="0.4" />
                                    <rect x="1.5" y="2" width="20" height="8" rx="1.5" fill="#000" />
                                </svg>
                            </div>
                        </div>
                        <div id="previewWrapper" class="bg-white overflow-hidden"
                            style="width:100%;height:100%;border-radius:0;">
                            <iframe id="previewFrame" class="w-full h-full border-0" src=""></iframe>
                        </div>
                        <div class="device-home-bar"></div>
                    </div>
                </div>
                <!-- 微调模式覆盖层 -->
                <div id="inspectorOverlay" class="hidden">
                    <div id="selectionBox" class="hidden"></div>
                </div>
            </div>
        </main>

        <!-- 右侧 PRD 侧边栏 -->
        <aside id="prdSidebar"
            class="prd-sidebar collapsed hidden-mode bg-white border-l border-gray-200 flex flex-col">
            <!-- 展开/收起按钮 - 固定在侧边栏内部左边缘 -->
            <button id="prdToggle"
                class="absolute left-0 top-1/2 -translate-y-1/2 w-4 h-12 bg-indigo-600 hover:bg-indigo-700 text-white rounded-l-md flex items-center justify-center cursor-pointer z-20 shadow-sm"
                style="transform: translateX(-100%) translateY(-50%);">
                <i class="fas fa-chevron-left" style="font-size: 9px;"></i>
            </button>

            <!-- 收起时的标签 -->
            <div id="prdCollapsedLabel" class="flex-1 flex items-center justify-center cursor-pointer hover:bg-gray-50"
                onclick="togglePrdSidebar()">
                <span class="text-gray-500 text-sm font-medium"
                    style="writing-mode: vertical-lr; transform: rotate(180deg);">PRD 文档</span>
            </div>

            <!-- 展开时的内容 -->
            <div id="prdContent" class="flex-1 flex-col hidden overflow-hidden">
                <!-- 头部 -->
                <div class="p-4 border-b border-gray-100 flex items-center justify-between flex-none">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-file-alt text-indigo-500"></i>
                        <span class="font-semibold text-gray-800">PRD 文档</span>
                    </div>
                </div>

                <!-- 编辑/预览切换 (仅编辑模式显示) -->
                <div id="prdTabs" class="flex border-b border-gray-100 flex-none">
                    <button id="prdEditTab"
                        class="flex-1 py-2 text-sm font-medium text-indigo-600 border-b-2 border-indigo-600">
                        <i class="fas fa-edit mr-1"></i> 编辑
                    </button>
                    <button id="prdPreviewTab"
                        class="flex-1 py-2 text-sm font-medium text-gray-500 hover:text-gray-700">
                        <i class="fas fa-eye mr-1"></i> 预览
                    </button>
                </div>

                <!-- 编辑器 -->
                <div id="prdEditor" class="flex-1 flex flex-col overflow-hidden">
                    <textarea id="prdTextarea"
                        class="flex-1 p-4 resize-none border-0 focus:outline-none focus:ring-0 text-sm font-mono leading-relaxed"
                        placeholder="# 页面 PRD

## 功能说明
描述此页面的主要功能...

## 交互规则
1. 点击按钮时...
2. 输入框验证...

## 数据字段
| 字段 | 类型 | 说明 |
|-----|-----|-----|
| name | string | 用户名 |
"></textarea>
                    <div
                        class="p-2 border-t border-gray-100 flex items-center justify-between text-xs text-gray-400 flex-none">
                        <span id="saveStatus">未保存</span>
                        <span>支持 Markdown 格式</span>
                    </div>
                </div>

                <!-- 预览区 -->
                <div id="prdPreview" class="flex-1 overflow-y-auto p-4 hidden">
                    <div id="prdPreviewContent" class="markdown-body text-sm"></div>
                </div>
            </div>
        </aside>
    </div>

    <!-- 微调模式弹窗 -->
    <div id="inspectorModal" class="hidden">
        <div class="inspector-modal-content">
            <div class="inspector-modal-header">
                <h3 style="font-weight: 600; color: #1f2937; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-magic" style="color: #ec4899;"></i>
                    微调请求
                </h3>
                <button onclick="closeInspectorModal()"
                    style="background: none; border: none; color: #9ca3af; cursor: pointer; font-size: 18px;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="inspector-modal-body">
                <div id="selectedElementsPreview" class="selected-elements-preview"></div>
                <textarea id="inspectorInput" placeholder="描述你想要的修改，例如：把这个按钮改成圆角，背景色改为蓝色，字体加大"></textarea>
            </div>
            <div class="inspector-modal-footer">
                <button class="inspector-btn inspector-btn-secondary" onclick="copyPrompt()">
                    <i class="fas fa-copy"></i>
                    复制 Prompt
                </button>
                <button class="inspector-btn inspector-btn-primary" onclick="applyWithAI()">
                    <i class="fas fa-bolt"></i>
                    AI 直接修改
                </button>
            </div>
        </div>
    </div>

    <!-- 微调模式提示 -->
    <div id="inspectorModeHint" class="inspector-mode-hint hidden">
        <i class="fas fa-crosshairs"></i>
        <span>点击选择元素，拖拽框选多个</span>
        <kbd>Ctrl+点击</kbd> 追加选择
        <kbd>Esc</kbd> 退出
        <!-- 整页面按钮 -->
        <button class="fullpage-btn" onclick="openFullPageModal()">
            <i class="fas fa-expand"></i> 整页面
        </button>
    </div>

    <!-- 整页面修改弹窗 -->
    <div id="fullPageModal" class="hidden">
        <div class="inspector-modal-content">
            <div class="inspector-modal-header">
                <h3 style="font-weight: 600; color: #1f2937; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-expand" style="color: #8b5cf6;"></i>
                    整页面修改
                </h3>
                <button onclick="closeFullPageModal()"
                    style="background: none; border: none; color: #9ca3af; cursor: pointer; font-size: 18px;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="inspector-modal-body">
                <div class="fullpage-info">
                    <div><strong>当前页面：</strong><span id="fullPageCurrentPage">-</span></div>
                </div>
                <textarea id="fullPageInput" placeholder="描述你想要的整页面修改，例如：整体改成暗色主题，添加页头导航栏，调整布局为左右两栏"></textarea>
            </div>
            <div class="inspector-modal-footer">
                <button class="inspector-btn inspector-btn-secondary" onclick="copyFullPagePrompt()">
                    <i class="fas fa-copy"></i>
                    复制 Prompt
                </button>
                <button class="inspector-btn inspector-btn-primary" onclick="applyFullPageWithAI()"
                    style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
                    <i class="fas fa-bolt"></i>
                    AI 直接修改
                </button>
            </div>
        </div>
    </div>

    <!-- Toast 容器 -->
    <div id="toastContainer" class="toast-container"></div>

    <script>
        console.log('%c[MAIN VIEWER] Script 开始加载', 'background: blue; color: white; font-weight: bold');
        // ==================== 状态管理 ====================
        let projectId = '';
        let currentPage = 'home';
        let currentMode = 'preview'; // 'preview' | 'edit' | 'dev' - 默认预览模式
        let prdExpanded = false;
        let pages = [];
        let saveTimer = null;
        let prdContent = {};
        let previewType = 'auto'; // 'auto' | 'mobile' | 'web'

        // ==================== 微调模式 (Inspector) 状态 ====================
        let inspectorActive = false;
        let selectedElements = [];
        let isBoxSelecting = false;
        let boxStartX = 0, boxStartY = 0;
        let inspectorEventHandlers = {}; // 存储事件处理器引用，便于移除

        // ==================== DOM 元素 ====================
        const $ = id => document.getElementById(id);

        // ==================== Toast 通知函数 ====================
        function showToast(message, type = 'success', duration = 2000) {
            const container = $('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            const icon = type === 'success' ? 'check-circle' : (type === 'warning' ? 'exclamation-triangle' : 'exclamation-circle');
            toast.innerHTML = `<i class="fas fa-${icon}"></i> ${message}`;
            container.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('hide');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        const previewFrame = $('previewFrame');
        const previewWrapper = $('previewWrapper');
        const prdSidebar = $('prdSidebar');
        const prdToggle = $('prdToggle');
        const prdCollapsedLabel = $('prdCollapsedLabel');
        const prdContentEl = $('prdContent');
        const prdTextarea = $('prdTextarea');
        const prdPreviewContent = $('prdPreviewContent');
        const prdPageName = $('prdPageName');
        const devSidebar = $('devSidebar');
        const flowchartView = $('flowchartView');
        const previewContainer = $('previewContainer');
        const pageList = $('pageList');

        // ==================== 初始化 ====================
        document.addEventListener('DOMContentLoaded', () => {
            // 从 URL 获取项目ID
            const params = new URLSearchParams(window.location.search);
            projectId = params.get('project') || '';

            if (!projectId) {
                alert('缺少项目ID参数');
                return;
            }

            // 设置标题
            $('projectTitle').textContent = decodeURIComponent(projectId.split('_')[0]);

            // 加载项目
            previewFrame.src = `/projects/${projectId}/index.html`;

            // iframe 加载完成后检测类型
            previewFrame.onload = () => {
                detectPreviewType();
                injectPageNavigationScript();
            };

            // 加载页面列表
            loadPages();

            // 设置事件监听
            setupEventListeners();

            // 初始化 Mermaid
            mermaid.initialize({ startOnLoad: false, theme: 'default' });

            // 开始页面检测
            console.log('[Viewer] 初始化：调用 startPageDetection');
            startPageDetection();

            // 设置视图选择器事件
            setupViewSelector();

            // 初始化为预览模式（使用 requestAnimationFrame 确保 DOM 已渲染）
            requestAnimationFrame(() => {
                switchMode('preview');
            });
        });

        // ==================== 事件监听 ====================
        function setupEventListeners() {
            // PRD 侧边栏切换
            prdToggle.onclick = togglePrdSidebar;

            // PRD 编辑/预览切换
            $('prdEditTab').onclick = () => switchPrdTab('edit');
            $('prdPreviewTab').onclick = () => switchPrdTab('preview');

            // PRD 自动保存
            prdTextarea.oninput = () => {
                $('saveStatus').textContent = '正在编辑...';
                clearTimeout(saveTimer);
                saveTimer = setTimeout(() => savePrd(), 1500);
                // 实时更新预览
                updatePrdPreview();
            };

            // 流程图入口
            $('flowchartEntry').onclick = showFlowchart;

            // 预览类型切换
            const previewTypeSelect = $('previewType');
            if (previewTypeSelect) {
                previewTypeSelect.onchange = (e) => {
                    previewType = e.target.value;
                    applyPreviewType();
                };
            }
        }

        // ==================== 预览类型自适应 ====================
        function detectPreviewType() {
            if (previewType !== 'auto') return;

            try {
                const iframeDoc = previewFrame.contentDocument || previewFrame.contentWindow.document;
                const body = iframeDoc.body;
                const html = iframeDoc.documentElement;
                const htmlContent = html.innerHTML;

                // 辅助函数：检测 aside 是否为始终可见的侧边栏（排除响应式隐藏的）
                const hasVisibleAside = (() => {
                    const asides = iframeDoc.querySelectorAll('aside');
                    for (const aside of asides) {
                        const cls = aside.className || '';
                        // 如果 aside 带有 hidden（且不是 md:flex/lg:flex 这种响应式显示），则是移动端隐藏的侧边栏
                        if (cls.includes('hidden') && (cls.includes('md:flex') || cls.includes('md:block') || cls.includes('lg:flex') || cls.includes('lg:block'))) {
                            continue; // 响应式隐藏的侧边栏，不算 Web 特征
                        }
                        return true; // 始终可见的侧边栏，算 Web 特征
                    }
                    return false;
                })();

                // 辅助函数：检测 w-64 是否为始终生效的（排除 md:w-64 等响应式类）
                const hasAlwaysVisibleSidebar = (() => {
                    // 检测 class="w-64"（非 md:w-64）的元素
                    const els = iframeDoc.querySelectorAll('[class*="w-64"]');
                    for (const el of els) {
                        const cls = el.className || '';
                        // 检查是否是响应式隐藏的元素
                        if (cls.includes('hidden') && (cls.includes('md:') || cls.includes('lg:'))) {
                            continue;
                        }
                        return true;
                    }
                    return false;
                })();

                // 检测 Web 端（后台管理系统）的特征
                const hasWebFeatures =
                    // 检测始终可见的侧边栏
                    hasVisibleAside ||
                    iframeDoc.querySelector('[class*="sidebar"]') !== null ||
                    // 检测 Ant Design 后台特征
                    htmlContent.includes('ant-dark') ||
                    htmlContent.includes('ant-table') ||
                    // 检测全屏 flex 布局（排除带有移动端底部导航的情况）
                    (body.classList.contains('flex') && htmlContent.includes('h-screen') && !htmlContent.includes('bottom-0')) ||
                    htmlContent.includes('w-screen') ||
                    // 检测后台管理常用宽度类（排除响应式隐藏的）
                    hasAlwaysVisibleSidebar ||
                    htmlContent.includes('w-72') ||
                    // 检测大型数据表格（多行多列，后台系统特征）
                    (iframeDoc.querySelector('table') !== null && iframeDoc.querySelectorAll('table tr').length > 3) ||
                    // 检测宽容器（非受限宽度，暗示Web布局）
                    htmlContent.includes('max-w-7xl') ||
                    htmlContent.includes('max-w-6xl') ||
                    htmlContent.includes('max-w-5xl') ||
                    htmlContent.includes('container mx-auto');

                // 检测移动端标识
                const hasMobileFeatures =
                    body.classList.contains('max-w-md') ||
                    htmlContent.includes('max-w-md') ||
                    htmlContent.includes('max-w-sm') ||
                    // 检测常见移动端宽度限制
                    htmlContent.includes('max-width: 430px') ||
                    htmlContent.includes('max-width:430px') ||
                    htmlContent.includes('max-width: 480px') ||
                    htmlContent.includes('max-width:480px') ||
                    htmlContent.includes('max-w-[480px]') ||
                    htmlContent.includes('max-w-[430px]') ||
                    // 检测移动端 viewport 设置
                    htmlContent.includes('user-scalable=no') ||
                    // 检测底部导航栏（移动端常见）- 更广泛的检测
                    iframeDoc.querySelector('[class*="bottom-nav"]') !== null ||
                    iframeDoc.querySelector('[class*="safe-area"]') !== null ||
                    iframeDoc.querySelector('nav[class*="fixed"][class*="bottom-0"]') !== null ||
                    iframeDoc.querySelector('[class*="pb-safe"]') !== null ||
                    // 检测 md:hidden 的 mobile header（表示有移动端专用头部）
                    iframeDoc.querySelector('header[class*="md:hidden"]') !== null ||
                    iframeDoc.querySelector('[class*="md:hidden"][class*="header"]') !== null ||
                    // 检测 #app 容器有移动端样式约束
                    (iframeDoc.querySelector('#app') &&
                        (iframeDoc.querySelector('#app').style.maxWidth === '480px' ||
                            iframeDoc.querySelector('#app').className.includes('max-w-')));

                console.log('[Viewer] 自动检测详情：hasWebFeatures=' + hasWebFeatures + ', hasMobileFeatures=' + hasMobileFeatures + ', hasVisibleAside=' + hasVisibleAside + ', hasAlwaysVisibleSidebar=' + hasAlwaysVisibleSidebar);

                // Web 特征优先（因为 Web 端有明确的侧边栏/宽布局等结构特征，更可靠）
                // 仅当没有 Web 特征时，才考虑移动端特征
                if (hasWebFeatures && !hasMobileFeatures) {
                    console.log('[Viewer] 自动检测：识别为 Web 端（检测到 Web 特征）');
                    setPreviewMode('web');
                } else if (hasMobileFeatures && !hasWebFeatures) {
                    console.log('[Viewer] 自动检测：识别为移动端（检测到移动端特征）');
                    setPreviewMode('mobile');
                } else if (hasWebFeatures && hasMobileFeatures) {
                    // 两者都有特征时，Web 优先（移动端误判概率更高）
                    console.log('[Viewer] 自动检测：Web/Mobile 均匹配，优先 Web');
                    setPreviewMode('web');
                } else {
                    // 兜底：根据内容宽度判断
                    const maxWidth = Math.max(
                        body.scrollWidth, body.offsetWidth,
                        html.clientWidth, html.scrollWidth, html.offsetWidth
                    );
                    if (maxWidth > 600) {
                        console.log('[Viewer] 自动检测（宽度）：识别为 Web 端, maxWidth=' + maxWidth);
                        setPreviewMode('web');
                    } else {
                        console.log('[Viewer] 自动检测（宽度）：识别为移动端, maxWidth=' + maxWidth);
                        setPreviewMode('mobile');
                    }
                }
            } catch (e) {
                console.log('[Viewer] 自动检测失败（可能跨域），默认移动端:', e);
                setPreviewMode('mobile');
            }
        }

        let currentPreviewMode = 'mobile';
        let showDeviceFrame = true;

        function setPreviewMode(mode) {
            currentPreviewMode = mode;
            const deviceFrame = $('deviceFrameWrapper');
            const toggleEls = document.querySelectorAll('#floatingDeviceToggle, #headerDeviceToggle');

            // 获取状态栏/灵动岛/底部横条元素
            const notchEl = deviceFrame.querySelector('.device-notch');
            const statusBarEl = deviceFrame.querySelector('.device-status-bar');
            const homeBarEl = deviceFrame.querySelector('.device-home-bar');

            if (mode === 'mobile') {
                // 显示/隐藏外壳开关
                toggleEls.forEach(el => el.style.display = '');
                // 恢复预览容器的内边距
                const container = $('previewContainer');
                if (container) {
                    container.style.padding = '';
                    container.classList.remove('web-mode');
                }
                // 恢复 device-screen 的原始样式
                const deviceScreen = deviceFrame.querySelector('div');
                if (deviceScreen && !deviceScreen.classList.contains('device-screen')) {
                    deviceScreen.className = 'device-screen';
                    deviceScreen.style.cssText = '';
                }

                if (showDeviceFrame) {
                    // 带外壳模式 - 显示所有元素
                    deviceFrame.className = 'device-frame';
                    deviceFrame.style.cssText = ''; // 清除残留行内样式（如 web 模式的 display:contents）
                    previewWrapper.className = 'bg-white overflow-hidden';
                    previewWrapper.style.cssText = 'width:100%;height:100%;border-radius:0;';
                    if (notchEl) notchEl.style.display = '';
                    if (statusBarEl) statusBarEl.style.display = '';
                    if (homeBarEl) homeBarEl.style.display = '';
                } else {
                    // 无外壳模式 - 隐藏状态栏、灵动岛、底部横条，纯显示页面
                    deviceFrame.className = '';
                    deviceFrame.style.cssText = '';
                    previewWrapper.className = 'bg-white overflow-hidden preview-frame-mobile';
                    previewWrapper.style.cssText = '';
                    if (notchEl) notchEl.style.display = 'none';
                    if (statusBarEl) statusBarEl.style.display = 'none';
                    if (homeBarEl) homeBarEl.style.display = 'none';
                }

                // 注入隐藏滚动条的样式到 iframe 内部
                injectHideScrollbar(true);
            } else {
                // Web 模式：隐藏外壳开关，移除外壳，去掉间距
                toggleEls.forEach(el => el.style.display = 'none');
                deviceFrame.className = '';
                deviceFrame.style.cssText = 'display:contents;';
                // device-screen 也需要去掉圆角和外壳样式
                const deviceScreen = deviceFrame.querySelector('.device-screen');
                if (deviceScreen) {
                    deviceScreen.className = '';
                    deviceScreen.style.cssText = 'width:100%;height:100%;border-radius:0;overflow:hidden;';
                }
                previewWrapper.className = 'bg-white overflow-hidden preview-frame-web';
                previewWrapper.style.cssText = '';
                if (notchEl) notchEl.style.display = 'none';
                if (statusBarEl) statusBarEl.style.display = 'none';
                if (homeBarEl) homeBarEl.style.display = 'none';
                injectHideScrollbar(false);
                // Web 模式去掉预览容器的内边距，让页面贴边显示
                const container = $('previewContainer');
                if (container) {
                    container.style.padding = '0';
                    container.classList.add('web-mode');
                }
            }
        }

        function injectHideScrollbar(inject) {
            try {
                const iframeDoc = $('previewFrame').contentDocument || $('previewFrame').contentWindow.document;
                if (!iframeDoc) return;
                if (inject) {
                    let s = iframeDoc.getElementById('hideScrollbarStyle');
                    if (!s) {
                        s = iframeDoc.createElement('style');
                        s.id = 'hideScrollbarStyle';
                        iframeDoc.head.appendChild(s);
                    }
                    // 当有真机外壳时，需要额外的 padding-top 让内容在状态栏下方显示
                    const statusBarPadding = showDeviceFrame ? 'body { padding-top: 54px !important; box-sizing: border-box !important; }' : '';
                    s.textContent = `
                        html, body { scrollbar-width: none !important; -ms-overflow-style: none !important; }
                        html::-webkit-scrollbar, body::-webkit-scrollbar { display: none !important; }
                        *::-webkit-scrollbar { width: 0 !important; height: 0 !important; }
                        ${statusBarPadding}
                    `;
                } else {
                    const s = iframeDoc.getElementById('hideScrollbarStyle');
                    if (s) s.remove();
                }
            } catch (e) { /* 跨域忽略 */ }
        }

        function toggleDeviceFrame(checked) {
            showDeviceFrame = checked;
            // 同步所有开关
            document.querySelectorAll('#floatingDeviceFrameToggle, #headerDeviceFrameToggle').forEach(el => el.checked = checked);
            // 重新应用当前模式
            if (currentPreviewMode === 'mobile') {
                setPreviewMode('mobile');
            }
        }

        function applyPreviewType(type) {
            // 如果传入了参数，更新全局变量
            if (type !== undefined) {
                previewType = type;
            }

            if (previewType === 'auto') {
                detectPreviewType();
            } else if (previewType === 'mobile') {
                setPreviewMode('mobile');
            } else {
                setPreviewMode('web');
            }
        }

        // ==================== 左侧边栏 展开/收起 ====================
        let devSidebarExpanded = false;
        function toggleDevSidebar() {
            devSidebarExpanded = !devSidebarExpanded;
            const content = $('devSidebarContent');
            const collapsedLabel = $('devSidebarCollapsedLabel');
            const toggleBtn = $('devSidebarToggle');

            if (devSidebarExpanded) {
                collapsedLabel.classList.add('hidden');
                content.classList.remove('hidden');
                content.classList.add('flex');
                toggleBtn.innerHTML = '<i class="fas fa-chevron-left" style="font-size: 9px;"></i>';
            } else {
                collapsedLabel.classList.remove('hidden');
                content.classList.add('hidden');
                content.classList.remove('flex');
                toggleBtn.innerHTML = '<i class="fas fa-chevron-right" style="font-size: 9px;"></i>';
            }
        }

        // ==================== PRD 侧边栏 ====================
        function togglePrdSidebar() {
            prdExpanded = !prdExpanded;
            if (prdExpanded) {
                prdSidebar.classList.remove('collapsed');
                prdSidebar.classList.add('expanded');
                prdCollapsedLabel.classList.add('hidden');
                prdContentEl.classList.remove('hidden');
                prdContentEl.classList.add('flex');
                prdToggle.innerHTML = '<i class="fas fa-chevron-right" style="font-size: 9px;"></i>';
                // 加载当前页面的 PRD
                loadPrd(currentPage);
            } else {
                prdSidebar.classList.remove('expanded');
                prdSidebar.classList.add('collapsed');
                prdCollapsedLabel.classList.remove('hidden');
                prdContentEl.classList.add('hidden');
                prdContentEl.classList.remove('flex');
                prdToggle.innerHTML = '<i class="fas fa-chevron-left" style="font-size: 9px;"></i>';
            }
        }

        function switchPrdTab(tab) {
            const editTab = $('prdEditTab');
            const previewTab = $('prdPreviewTab');
            const editor = $('prdEditor');
            const preview = $('prdPreview');

            if (tab === 'edit') {
                editTab.classList.add('text-indigo-600', 'border-b-2', 'border-indigo-600');
                editTab.classList.remove('text-gray-500');
                previewTab.classList.remove('text-indigo-600', 'border-b-2', 'border-indigo-600');
                previewTab.classList.add('text-gray-500');
                editor.classList.remove('hidden');
                editor.classList.add('flex');
                preview.classList.add('hidden');
            } else {
                previewTab.classList.add('text-indigo-600', 'border-b-2', 'border-indigo-600');
                previewTab.classList.remove('text-gray-500');
                editTab.classList.remove('text-indigo-600', 'border-b-2', 'border-indigo-600');
                editTab.classList.add('text-gray-500');
                editor.classList.add('hidden');
                editor.classList.remove('flex');
                preview.classList.remove('hidden');
                updatePrdPreview();
            }
        }

        function updatePrdPreview() {
            const content = prdTextarea.value;
            prdPreviewContent.innerHTML = marked.parse(content || '*暂无内容*');
        }

        // ==================== PRD 加载/保存 ====================
        async function loadPrd(pageName) {
            try {
                const res = await fetch(`/api/prd/load?projectId=${encodeURIComponent(projectId)}&pageName=${encodeURIComponent(pageName)}`);
                const data = await res.json();
                prdTextarea.value = data.content || '';
                if (prdPageName) prdPageName.textContent = pageName;
                prdContent[pageName] = data.content || '';
                updatePrdPreview();
                $('saveStatus').textContent = data.content ? '已加载' : '新文档';
            } catch (e) {
                console.error('加载 PRD 失败:', e);
            }
        }

        async function savePrd() {
            try {
                const content = prdTextarea.value;
                $('saveStatus').textContent = '保存中...';

                const res = await fetch('/api/prd/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        projectId: projectId,
                        pageName: currentPage,
                        content: content
                    })
                });

                const data = await res.json();
                if (data.success) {
                    $('saveStatus').textContent = '已保存';
                    prdContent[currentPage] = content;
                } else {
                    $('saveStatus').textContent = '保存失败';
                }
            } catch (e) {
                console.error('保存 PRD 失败:', e);
                $('saveStatus').textContent = '保存失败';
            }
        }

        // ==================== 模式切换 ====================
        function switchMode(mode) {
            // 在函数内获取 DOM 元素，确保 DOM 已加载
            const mainHeader = $('mainHeader');
            const previewToolbar = $('previewToolbar');

            currentMode = mode;

            // 更新下拉菜单选中状态
            document.querySelectorAll('.mode-option').forEach(el => {
                el.classList.remove('active');
            });
            const modeOption = document.querySelector(`.mode-option.${mode}-mode`);
            if (modeOption) modeOption.classList.add('active');

            // 更新浮动工具栏模式按钮状态
            document.querySelectorAll('.compact-mode-btn[data-mode]').forEach(btn => {
                const check = btn.querySelector('.mode-check');
                if (btn.dataset.mode === mode) {
                    btn.style.background = btn.dataset.mode === 'preview' ? '#ecfdf5' :
                        btn.dataset.mode === 'edit' ? '#eef2ff' :
                            btn.dataset.mode === 'inspector' ? '#fdf2f8' : '#fffbeb';
                    if (check) check.style.display = 'inline';
                } else {
                    btn.style.background = '';
                    if (check) check.style.display = 'none';
                }
            });

            // 更新触发器显示
            const iconEl = $('currentModeIcon');
            const nameEl = $('currentModeName');

            // 重置状态
            document.body.classList.remove('preview-fullscreen');

            // 如果从 inspector 模式切换到其他模式，需要禁用 inspector
            if (inspectorActive && mode !== 'inspector') {
                disableInspector();
            }

            if (mode === 'preview') {
                iconEl.className = 'fas fa-eye text-green-600';
                nameEl.textContent = '预览模式';
                // 预览模式：隐藏 header，显示悬浮工具栏
                mainHeader.style.display = 'none';
                previewToolbar.style.display = 'block';
                devSidebar.classList.add('hidden');
                devSidebar.classList.remove('flex');
                prdSidebar.classList.add('hidden-mode');
                flowchartView.classList.add('hidden');
                previewContainer.classList.remove('hidden');
                document.body.classList.add('preview-fullscreen');
            } else if (mode === 'edit') {
                iconEl.className = 'fas fa-edit text-indigo-600';
                nameEl.textContent = '编辑模式';
                // 编辑模式：隐藏 header，显示悬浮工具栏（统一交互）
                mainHeader.style.display = 'none';
                previewToolbar.style.display = 'block';
                // 编辑模式也显示左侧边栏（默认收起），便于切换页面和对应 PRD
                devSidebar.classList.remove('hidden');
                devSidebar.classList.add('flex');
                // 确保左侧边栏保持当前状态（默认收起）
                if (!devSidebarExpanded) {
                    $('devSidebarCollapsedLabel').classList.remove('hidden');
                    $('devSidebarContent').classList.add('hidden');
                    $('devSidebarContent').classList.remove('flex');
                }
                // 编辑模式隐藏流程图入口（仅研发模式使用）
                const flowchartEntryEdit = $('flowchartEntry');
                if (flowchartEntryEdit) flowchartEntryEdit.style.display = 'none';
                prdSidebar.classList.remove('hidden-mode');
                $('prdTabs').classList.remove('hidden');
                flowchartView.classList.add('hidden');
                previewContainer.classList.remove('hidden');
                prdTextarea.disabled = false;
                switchPrdTab('edit');
                if (!prdExpanded) {
                    togglePrdSidebar();
                }
            } else if (mode === 'dev') {
                iconEl.className = 'fas fa-code text-amber-600';
                nameEl.textContent = '研发模式';
                // 研发模式：隐藏 header，显示悬浮工具栏（统一交互）
                mainHeader.style.display = 'none';
                previewToolbar.style.display = 'block';
                devSidebar.classList.remove('hidden');
                devSidebar.classList.add('flex');
                // 确保左侧边栏保持当前状态（默认收起）
                if (!devSidebarExpanded) {
                    $('devSidebarCollapsedLabel').classList.remove('hidden');
                    $('devSidebarContent').classList.add('hidden');
                    $('devSidebarContent').classList.remove('flex');
                }
                // 研发模式显示流程图入口
                const flowchartEntryDev = $('flowchartEntry');
                if (flowchartEntryDev) flowchartEntryDev.style.display = '';
                prdSidebar.classList.remove('hidden-mode');
                $('prdTabs').classList.add('hidden');
                prdTextarea.disabled = true;
                switchPrdTab('preview');
                if (!prdExpanded) {
                    togglePrdSidebar();
                }
            } else if (mode === 'inspector') {
                iconEl.className = 'fas fa-crosshairs text-pink-600';
                nameEl.textContent = '微调模式';
                // 微调模式：全屏预览 + 启用元素选择
                mainHeader.style.display = 'none';
                previewToolbar.style.display = 'block';
                devSidebar.classList.add('hidden');
                devSidebar.classList.remove('flex');
                prdSidebar.classList.add('hidden-mode');
                flowchartView.classList.add('hidden');
                previewContainer.classList.remove('hidden');
                document.body.classList.add('preview-fullscreen');
                // 启用 Inspector
                enableInspector();
            }
        }

        // 视图选择器事件
        function setupViewSelector() {
            // 为所有视图选择器添加事件
            document.querySelectorAll('.compact-view-selector .view-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const view = btn.dataset.view;
                    // 更新所有选择器的按钮状态
                    document.querySelectorAll('.compact-view-selector .view-btn').forEach(b => {
                        if (b.dataset.view === view) {
                            b.classList.add('active');
                        } else {
                            b.classList.remove('active');
                        }
                    });
                    // 应用视图类型
                    applyPreviewType(view);
                });
            });
        }

        // ==================== 页面列表 ====================
        async function loadPages() {
            try {
                const res = await fetch(`/api/pages?projectId=${encodeURIComponent(projectId)}`);
                const data = await res.json();
                pages = data.pages || [];
                renderPageList();
            } catch (e) {
                console.error('加载页面列表失败:', e);
                pageList.innerHTML = '<div class="p-4 text-center text-red-500 text-sm">加载失败</div>';
            }
        }

        function renderPageList() {
            if (pages.length === 0) {
                pageList.innerHTML = '<div class="p-4 text-center text-gray-400 text-sm">无页面</div>';
                return;
            }

            pageList.innerHTML = pages.map(p => `
                <div class="page-item px-4 py-3 cursor-pointer ${p.name === currentPage ? 'active' : ''}"
                     onclick="navigateToPage('${p.name}')">
                    <div class="flex items-center gap-3">
                        <i class="fas fa-file text-gray-400"></i>
                        <div>
                            <div class="font-medium text-gray-800">${p.label}</div>
                            <div class="text-xs text-gray-400">${p.name}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // 注入页面导航脚本到 iframe
        function injectPageNavigationScript() {
            try {
                const iframeWindow = previewFrame.contentWindow;

                // 注入消息监听器
                const script = iframeWindow.document.createElement('script');
                script.textContent = `
                    window.addEventListener('message', function(event) {
                        if (event.data && event.data.type === 'navigateTo') {
                            const pageName = event.data.page;
                            const routePath = event.data.routePath;
                            
                            // 方式1: Vue currentPage ref
                            if (typeof currentPage !== 'undefined') {
                                if (currentPage.value !== undefined) {
                                    currentPage.value = pageName;
                                } else {
                                    currentPage = pageName;
                                }
                            }
                            
                            // 方式2: Vue Router
                            if (routePath && window.__vueRouter__) {
                                window.__vueRouter__.push(routePath);
                            } else if (routePath) {
                                // 直接修改 hash（适用于 createWebHashHistory）
                                window.location.hash = '#' + routePath;
                            }
                            
                            // 通知父窗口页面已切换
                            window.parent.postMessage({ type: 'pageChange', page: pageName }, '*');
                        }
                    });
                    
                    // 尝试暴露 Vue Router 到 window
                    (function() {
                        var checkRouter = setInterval(function() {
                            // 搜索 Vue app 实例中的 router
                            var appEl = document.getElementById('app');
                            if (appEl && appEl.__vue_app__) {
                                var router = appEl.__vue_app__.config.globalProperties.$router;
                                if (router) {
                                    window.__vueRouter__ = router;
                                    clearInterval(checkRouter);
                                    console.log('[原型] Vue Router 已暴露到 window');
                                    
                                    // 监听路由变化并通知父窗口
                                    router.afterEach(function(to) {
                                        var pageName = to.path === '/' ? 'home' : to.path.replace(/^\//, '');
                                        window.parent.postMessage({ type: 'pageChange', page: pageName }, '*');
                                    });
                                }
                            }
                        }, 200);
                        // 5秒后停止检查
                        setTimeout(function() { clearInterval(checkRouter); }, 5000);
                    })();
                    
                    // 监听 currentPage 变化并通知父窗口
                    if (typeof currentPage !== 'undefined') {
                        setInterval(function() {
                            var page = currentPage.value || currentPage;
                            window.parent.postMessage({ type: 'pageChange', page: page }, '*');
                        }, 500);
                    }
                    
                    // 监听 hash 变化（Vue Router hash 模式）
                    window.addEventListener('hashchange', function() {
                        var hash = window.location.hash.replace('#', '');
                        var pageName = hash === '/' || hash === '' ? 'home' : hash.replace(/^\//, '');
                        window.parent.postMessage({ type: 'pageChange', page: pageName }, '*');
                    });
                `;
                iframeWindow.document.body.appendChild(script);
            } catch (e) {
                console.log('无法注入脚本 (可能是跨域限制):', e);
            }
        }

        function navigateToPage(pageName) {
            // 切换前自动保存当前页面的 PRD（防止丢失编辑内容）
            if (prdExpanded && prdTextarea.value && currentPage !== pageName) {
                savePrd();
            }

            // 隐藏流程图，显示预览
            flowchartView.classList.add('hidden');
            previewContainer.classList.remove('hidden');

            console.log('[Viewer] 正在切换到页面:', pageName);

            // 查找页面信息（判断是 currentPage 类型还是 router 类型）
            const pageInfo = pages.find(p => p.name === pageName);
            const isRouterPage = pageInfo && pageInfo.type === 'router';
            const routePath = pageInfo && pageInfo.routePath;

            // 尝试多种方式切换 iframe 内的页面
            try {
                const iframeWindow = previewFrame.contentWindow;

                if (isRouterPage && routePath) {
                    // Vue Router 模式：直接修改 iframe 的 hash（同源可直接访问）
                    console.log('[Viewer] 使用 Vue Router 导航:', routePath);
                    try {
                        // 方法1: 直接修改 hash（最可靠，适用于 createWebHashHistory）
                        iframeWindow.location.hash = '#' + routePath;
                        console.log('[Viewer] ✓ 已设置 hash:', '#' + routePath);
                    } catch (hashErr) {
                        console.log('[Viewer] 直接设置 hash 失败:', hashErr);
                    }
                    // 方法2: 通过 postMessage 备用（可触发 __vueRouter__.push）
                    iframeWindow.postMessage({
                        type: 'navigateTo',
                        page: pageName,
                        routePath: routePath
                    }, '*');
                } else {
                    // currentPage 模式
                    console.log('[Viewer] iframe.currentPage:', iframeWindow.currentPage);

                    // 方法1: 直接修改 window.currentPage (Vue 3 ref)
                    if (iframeWindow.currentPage) {
                        if (iframeWindow.currentPage.value !== undefined) {
                            const oldPage = iframeWindow.currentPage.value;
                            iframeWindow.currentPage.value = pageName;
                            console.log('[Viewer] ✓ 页面已切换:', oldPage, '->', pageName);
                        } else {
                            console.log('[Viewer] currentPage 不是 ref:', typeof iframeWindow.currentPage);
                        }
                    } else {
                        console.log('[Viewer] ✗ iframe 中没有 currentPage');
                    }

                    // 方法2: 通过 postMessage
                    iframeWindow.postMessage({
                        type: 'navigateTo',
                        page: pageName
                    }, '*');
                }

                console.log('[Viewer] 已发送导航请求');

            } catch (e) {
                console.log('[Viewer] 页面切换异常:', e);
            }

            // 更新当前页面状态
            currentPage = pageName;
            if (prdPageName) prdPageName.textContent = pageName;
            renderPageList();

            // 加载对应 PRD
            loadPrd(pageName);
        }

        // ==================== 流程图 ====================
        async function showFlowchart() {
            try {
                flowchartView.classList.remove('hidden');
                previewContainer.classList.add('hidden');

                const res = await fetch(`/api/flowchart?projectId=${encodeURIComponent(projectId)}`);
                const data = await res.json();

                if (data.mermaid) {
                    const container = $('flowchartContainer');
                    container.innerHTML = '<div class="text-gray-400">正在生成流程图...</div>';

                    try {
                        const { svg } = await mermaid.render('flowchart-svg', data.mermaid);
                        container.innerHTML = svg;
                    } catch (mermaidErr) {
                        console.error('Mermaid 渲染错误:', mermaidErr);
                        // 显示原始代码作为备选
                        container.innerHTML = `
                            <div class="bg-red-50 p-4 rounded-lg text-red-600 mb-4">
                                <i class="fas fa-exclamation-triangle mr-2"></i>
                                流程图渲染失败，显示原始代码
                            </div>
                            <pre class="bg-gray-100 p-4 rounded-lg text-sm overflow-auto">${data.mermaid}</pre>
                        `;
                    }

                    // 添加弹窗/交互说明
                    if (data.modals && data.modals.length > 0) {
                        const modalsHtml = `
                            <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                                <h3 class="font-semibold text-gray-700 mb-3">
                                    <i class="fas fa-window-restore text-indigo-500 mr-2"></i>弹窗/交互组件
                                </h3>
                                <div class="grid grid-cols-2 gap-2">
                                    ${data.modals.map(m => `
                                        <div class="flex items-center gap-2 text-sm text-gray-600">
                                            <span class="w-2 h-2 bg-indigo-400 rounded-full"></span>
                                            ${m.label}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                        container.insertAdjacentHTML('beforeend', modalsHtml);
                    }

                    // 显示页面转换详情
                    if (data.transitions && data.transitions.length > 0) {
                        const transitionsHtml = `
                            <div class="mt-4 p-4 bg-blue-50 rounded-lg">
                                <h3 class="font-semibold text-gray-700 mb-3">
                                    <i class="fas fa-exchange-alt text-blue-500 mr-2"></i>页面跳转关系 (${data.transitions.length}个)
                                </h3>
                                <div class="space-y-1 text-sm">
                                    ${data.transitions.map(t => `
                                        <div class="flex items-center gap-2 text-gray-600">
                                            <span class="font-medium">${t.from}</span>
                                            <i class="fas fa-arrow-right text-gray-400"></i>
                                            <span class="font-medium">${t.to}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                        container.insertAdjacentHTML('beforeend', transitionsHtml);
                    }
                }
            } catch (e) {
                console.error('加载流程图失败:', e);
                $('flowchartContainer').innerHTML = '<div class="text-red-500"><i class="fas fa-exclamation-circle mr-2"></i>加载失败: ' + e.message + '</div>';
            }
        }

        // ==================== 页面检测 ====================
        function startPageDetection() {
            // 检测函数
            function detectCurrentPage() {
                try {
                    const iframeWindow = previewFrame.contentWindow;
                    if (!iframeWindow) {
                        console.log('[页面检测] iframeWindow 不存在');
                        return;
                    }

                    // 方式1: 直接读取 currentPage 变量
                    if (iframeWindow.currentPage) {
                        const detectedPage = iframeWindow.currentPage.value || iframeWindow.currentPage;
                        console.log('[页面检测] iframe页面:', detectedPage, ', viewer页面:', currentPage);
                        if (detectedPage && typeof detectedPage === 'string' && detectedPage !== currentPage) {
                            console.log('[页面检测] 发现变化:', currentPage, '->', detectedPage);
                            onPageChange(detectedPage);
                        }
                        return; // currentPage 模式，不需要检测 hash
                    }

                    // 方式2: 检测 Vue Router hash 变化
                    const iframeHash = iframeWindow.location.hash;
                    if (iframeHash) {
                        const hashPath = iframeHash.replace('#', '');
                        const detectedPage = (hashPath === '/' || hashPath === '') ? 'home' : hashPath.replace(/^\//, '');
                        if (detectedPage && detectedPage !== currentPage) {
                            console.log('[页面检测] Hash变化:', currentPage, '->', detectedPage);
                            onPageChange(detectedPage);
                        }
                    }
                } catch (e) {
                    console.log('[页面检测] 错误:', e.message);
                }
            }

            // 每 500ms 检测一次
            setInterval(detectCurrentPage, 500);

            console.log('[Viewer] 正在注册 message 监听器...');

            // 监听来自 iframe 的消息
            window.addEventListener('message', (event) => {
                console.log('[Viewer] 收到消息:', event.data);
                if (event.data && event.data.type === 'pageChange') {
                    const newPage = event.data.page;
                    console.log('[postMessage] 收到页面变化:', newPage);
                    if (newPage && typeof newPage === 'string' && newPage !== currentPage) {
                        onPageChange(newPage);
                    }
                }
            });

            // 监听 iframe 加载完成后立即检测
            previewFrame.addEventListener('load', () => {
                setTimeout(detectCurrentPage, 100);
            });
        }

        function onPageChange(newPage) {
            if (newPage === currentPage) return;

            // 切换前自动保存当前页面的 PRD
            if (prdExpanded && prdTextarea.value) {
                savePrd();
            }

            console.log(`[Viewer] 页面切换: ${currentPage} -> ${newPage}`);
            currentPage = newPage;
            renderPageList();

            // 加载新页面的 PRD
            loadPrd(newPage);
        }

        // ==================== 微调模式 (Inspector) ====================

        function enableInspector() {
            if (inspectorActive) return;
            inspectorActive = true;
            console.log('[Inspector] 启用微调模式');

            const overlay = $('inspectorOverlay');
            const hint = $('inspectorModeHint');

            overlay.classList.remove('hidden');
            overlay.classList.add('active');
            hint.classList.remove('hidden');

            try {
                const iframeDoc = previewFrame.contentDocument;
                if (!iframeDoc) {
                    console.error('[Inspector] 无法访问 iframe 文档');
                    return;
                }

                // 注入 Inspector CSS 到 iframe
                injectInspectorStyles(iframeDoc);

                // 绑定 overlay 事件 (接管所有交互)
                overlay.addEventListener('mousedown', onBoxSelectStart);
                overlay.addEventListener('mousemove', onOverlayMouseMove);
                overlay.addEventListener('mouseup', onBoxSelectEnd);
                overlay.addEventListener('mouseleave', onOverlayMouseLeave);

            } catch (e) {
                console.error('[Inspector] 启用失败:', e);
            }

            document.addEventListener('keydown', onInspectorKeyDown);
        }

        function disableInspector() {
            if (!inspectorActive) return;
            inspectorActive = false;
            console.log('[Inspector] 禁用微调模式');

            const overlay = $('inspectorOverlay');
            const hint = $('inspectorModeHint');

            overlay.classList.add('hidden');
            overlay.classList.remove('active');
            hint.classList.add('hidden');

            // 关闭弹窗
            closeInspectorModal();

            // 清除选择
            clearAllSelections();
            clearHighlight();

            // 移除 overlay 事件
            overlay.removeEventListener('mousedown', onBoxSelectStart);
            overlay.removeEventListener('mousemove', onOverlayMouseMove);
            overlay.removeEventListener('mouseup', onBoxSelectEnd);
            overlay.removeEventListener('mouseleave', onOverlayMouseLeave);

            document.removeEventListener('keydown', onInspectorKeyDown);
        }

        function injectInspectorStyles(doc) {
            if (doc.getElementById('inspector-styles')) return;

            const style = doc.createElement('style');
            style.id = 'inspector-styles';
            style.textContent = `
                .inspector-highlight {
                    outline: 2px solid #ec4899 !important;
                    outline-offset: 2px;
                    background-color: rgba(236, 72, 153, 0.1) !important;
                }
                .inspector-selected {
                    outline: 3px solid #ec4899 !important;
                    outline-offset: 2px;
                    background-color: rgba(236, 72, 153, 0.25) !important;
                }
            `;
            doc.head.appendChild(style);
        }

        // ==================== Overlay Interaction Logic ====================

        function onOverlayMouseMove(e) {
            if (isBoxSelecting) {
                onBoxSelectMove(e);
            } else {
                highlightElementAtPoint(e.clientX, e.clientY);
            }
        }

        function onOverlayMouseLeave(e) {
            clearHighlight();
        }

        let lastHighlightedElement = null;

        function highlightElementAtPoint(x, y) {
            try {
                const iframeDoc = previewFrame.contentDocument;
                const iframeRect = previewFrame.getBoundingClientRect();

                // 计算相对于 iframe 视口的坐标
                const iframeX = x - iframeRect.left;
                const iframeY = y - iframeRect.top;

                // 获取最顶层元素
                const el = iframeDoc.elementFromPoint(iframeX, iframeY);

                if (lastHighlightedElement !== el) {
                    if (lastHighlightedElement) {
                        try { lastHighlightedElement.classList.remove('inspector-highlight'); } catch (e) { }
                    }
                    if (el && el.tagName !== 'HTML' && el.tagName !== 'BODY') {
                        el.classList.add('inspector-highlight');
                        lastHighlightedElement = el;
                    } else {
                        lastHighlightedElement = null;
                    }
                }
            } catch (e) {
                // Ignore transient errors
            }
        }

        function clearHighlight() {
            if (lastHighlightedElement) {
                try {
                    lastHighlightedElement.classList.remove('inspector-highlight');
                } catch (e) { }
                lastHighlightedElement = null;
            }
        }

        // 记录点击位置，区分点击和拖拽
        let dragStartX = 0;
        let dragStartY = 0;

        function onBoxSelectStart(e) {
            // 检查区域
            const wrapperRect = previewWrapper.getBoundingClientRect();
            if (e.clientX < wrapperRect.left || e.clientX > wrapperRect.right ||
                e.clientY < wrapperRect.top || e.clientY > wrapperRect.bottom) {
                return;
            }

            isBoxSelecting = true;
            const rect = previewContainer.getBoundingClientRect();
            boxStartX = e.clientX - rect.left;
            boxStartY = e.clientY - rect.top;

            dragStartX = e.clientX;
            dragStartY = e.clientY;

            const box = $('selectionBox');
            box.style.left = boxStartX + 'px';
            box.style.top = boxStartY + 'px';
            box.style.width = '0';
            box.style.height = '0';
            box.classList.remove('hidden');
        }

        function onBoxSelectMove(e) {
            if (!isBoxSelecting) return;

            const rect = previewContainer.getBoundingClientRect();
            const currentX = e.clientX - rect.left;
            const currentY = e.clientY - rect.top;

            const box = $('selectionBox');
            const left = Math.min(boxStartX, currentX);
            const top = Math.min(boxStartY, currentY);
            const width = Math.abs(currentX - boxStartX);
            const height = Math.abs(currentY - boxStartY);

            box.style.left = left + 'px';
            box.style.top = top + 'px';
            box.style.width = width + 'px';
            box.style.height = height + 'px';
        }

        function onBoxSelectEnd(e) {
            if (!isBoxSelecting) return;
            isBoxSelecting = false;

            const box = $('selectionBox');
            box.classList.add('hidden');

            // 计算移动距离
            const dist = Math.sqrt(Math.pow(e.clientX - dragStartX, 2) + Math.pow(e.clientY - dragStartY, 2));

            if (dist < 5) {
                // === 点击操作 ===
                handleInspectorClick(e);
            } else {
                // === 框选操作 ===
                const boxRect = {
                    left: parseInt(box.style.left),
                    top: parseInt(box.style.top),
                    width: parseInt(box.style.width),
                    height: parseInt(box.style.height)
                };

                // 忽略极小的框选
                if (boxRect.width > 5 && boxRect.height > 5) {
                    selectElementsInBox(boxRect);
                    if (selectedElements.length > 0) {
                        showInspectorModal();
                    }
                }
            }
        }

        function handleInspectorClick(e) {
            // 获取点击位置元素
            const iframeDoc = previewFrame.contentDocument;
            const iframeRect = previewFrame.getBoundingClientRect();
            const el = iframeDoc.elementFromPoint(e.clientX - iframeRect.left, e.clientY - iframeRect.top);

            if (!el || el.tagName === 'HTML' || el.tagName === 'BODY') return;

            // Ctrl/Cmd 追加选择
            if (e.ctrlKey || e.metaKey) {
                if (selectedElements.includes(el)) {
                    el.classList.remove('inspector-selected');
                    selectedElements = selectedElements.filter(x => x !== el);
                } else {
                    el.classList.add('inspector-selected');
                    selectedElements.push(el);
                }
            } else {
                // 单选
                clearAllSelections();
                el.classList.add('inspector-selected');
                selectedElements = [el];
            }

            console.log('[Inspector] 选中:', el.tagName, '总数:', selectedElements.length);

            // 始终显示面板（即便是单选，因为不再模态全屏了）
            showInspectorModal();
        }

        function selectElementsInBox(boxRect) {
            clearAllSelections();

            try {
                const iframeDoc = previewFrame.contentDocument;
                // 使用 previewFrame 的位置来转换坐标
                const iframeRect = previewFrame.getBoundingClientRect();

                // 获取 iframe 的边框宽度，因为 getBoundingClientRect 包含边框，但 elementFromPoint 是从内容区域开始计算的
                const style = window.getComputedStyle(previewFrame);
                const borderLeft = parseFloat(style.borderLeftWidth) || 0;
                const borderTop = parseFloat(style.borderTopWidth) || 0;

                // 将屏幕坐标系的框选区域转换为 iframe 内部坐标系 (减去边框)
                const selectionRect = {
                    left: boxRect.left - iframeRect.left - borderLeft,
                    top: boxRect.top - iframeRect.top - borderTop,
                    right: boxRect.right - iframeRect.left - borderLeft,
                    bottom: boxRect.bottom - iframeRect.top - borderTop,
                    width: boxRect.width,
                    height: boxRect.height
                };

                // 鲁棒性处理：确保 right/bottom 存在
                if (!selectionRect.right) selectionRect.right = selectionRect.left + selectionRect.width;
                if (!selectionRect.bottom) selectionRect.bottom = selectionRect.top + selectionRect.height;

                // 遍历可交互元素
                // 扩大选择范围，避免漏掉一些容器
                const selectableElements = iframeDoc.querySelectorAll('button, input, img, a, p, h1, h2, h3, h4, h5, h6, span, div, li, ul, ol, label, select, textarea, table, tr, td, th');

                selectableElements.forEach(el => {
                    // 排除隐藏元素
                    if (el.offsetParent === null) return;

                    const elRect = el.getBoundingClientRect(); // relative to iframe viewport

                    // 1. 几何相交检测
                    if (rectsIntersect(selectionRect, elRect) && el.offsetWidth > 0 && el.offsetHeight > 0) {

                        // 2. 遮挡检测 (Crucial fix - 增强版)
                        // 为了避免因为单个中心点被遮挡（如浮动标签、小图标）而导致整个元素未选中，
                        // 我们检测 5 个点：中心 + 4个角（向内收缩一点以防边缘对齐问题）

                        // 计算交集区域
                        const intersectLeft = Math.max(selectionRect.left, elRect.left);
                        const intersectTop = Math.max(selectionRect.top, elRect.top);
                        const intersectRight = Math.min(selectionRect.right, elRect.right);
                        const intersectBottom = Math.min(selectionRect.bottom, elRect.bottom);

                        const width = intersectRight - intersectLeft;
                        const height = intersectBottom - intersectTop;

                        if (width <= 0 || height <= 0) return;

                        const centerX = intersectLeft + width / 2;
                        const centerY = intersectTop + height / 2;

                        // 定义检测点集合 (向内收缩 20% 或 2px，避免正好压在边框上)
                        const paddingX = Math.min(width * 0.2, 2);
                        const paddingY = Math.min(height * 0.2, 2);

                        const pointsToCheck = [
                            { x: centerX, y: centerY }, // 中心
                            { x: intersectLeft + paddingX, y: intersectTop + paddingY }, // 左上
                            { x: intersectRight - paddingX, y: intersectTop + paddingY }, // 右上
                            { x: intersectLeft + paddingX, y: intersectBottom - paddingY }, // 左下
                            { x: intersectRight - paddingX, y: intersectBottom - paddingY }  // 右下
                        ];

                        let isVisible = false;

                        for (const point of pointsToCheck) {
                            // 检查该点最上层的元素
                            const topEl = iframeDoc.elementFromPoint(point.x, point.y);

                            // 只要有一个点命中了当前元素（或者是其亲属），就认为可见
                            if (topEl && (el === topEl || el.contains(topEl) || topEl.contains(el))) {
                                isVisible = true;
                                break;
                            }

                            // 特殊处理：如果 topEl 是 label 且 el 是 input，通常认为是相关的
                            if (topEl && topEl.tagName === 'LABEL' && el.tagName === 'INPUT') {
                                isVisible = true;
                                break;
                            }
                        }

                        if (isVisible) {
                            el.classList.add('inspector-selected');
                            selectedElements.push(el);
                        }
                    }
                });

                // 可选：后处理

            } catch (e) {
                console.error('[Inspector] 框选失败:', e);
            }
        }

        function rectsIntersect(r1, r2) {
            return !(r1.right < r2.left || r1.left > r2.right || r1.bottom < r2.top || r1.top > r2.bottom);
        }

        function clearAllSelections() {
            selectedElements.forEach(el => {
                try {
                    el.classList.remove('inspector-selected', 'inspector-highlight');
                } catch (e) { }
            });
            selectedElements = [];
        }

        function onInspectorKeyDown(e) {
            if (e.key === 'Escape') {
                const modal = $('inspectorModal');
                if (modal.classList.contains('active')) {
                    // 如果弹窗打开，先关弹窗
                    closeInspectorModal();
                } else {
                    // 否则退出模式
                    switchMode('preview');
                }
            }
        }

        // ==================== Inspector 弹窗与 Prompt 生成 ====================

        function showInspectorModal() {
            const preview = $('selectedElementsPreview');
            preview.innerHTML = selectedElements.map((el, i) => {
                const selector = generateSelector(el);
                const summary = el.tagName.toLowerCase() + (el.id ? '#' + el.id : '') + (el.className ? '.' + el.className.split(' ')[0] : '');

                return `<div class="selected-element-item">
                    <div class="selected-element-tag">
                         <span class="font-bold text-primary">${i + 1}. ${summary}</span>
                    </div>
                </div>`;
            }).join('');

            const modal = $('inspectorModal');
            modal.classList.remove('hidden');
            modal.classList.add('active');

            // 不自动聚焦 input，以便用户继续操作
            // $('inspectorInput').focus(); 
        }

        function closeInspectorModal() {
            const modal = $('inspectorModal');
            modal.classList.add('hidden');
            modal.classList.remove('active');
            $('inspectorInput').value = '';
        }

        function generateSelector(el) {
            // 生成唯一 CSS Selector
            const path = [];
            let current = el;
            while (current && current.nodeType === Node.ELEMENT_NODE && current.tagName !== 'BODY' && current.tagName !== 'HTML') {
                let selector = current.tagName.toLowerCase();
                if (current.id) {
                    selector = '#' + current.id;
                    path.unshift(selector);
                    break;
                } else if (current.className && typeof current.className === 'string') {
                    const classes = current.className.trim().split(/\s+/).filter(c => c && !c.startsWith('inspector-'));
                    if (classes.length > 0) {
                        selector += '.' + classes.slice(0, 2).join('.');
                    }
                }
                path.unshift(selector);
                current = current.parentElement;
            }
            return path.join(' > ');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function generatePrompt() {
            const userInput = $('inspectorInput').value.trim();
            if (!userInput) {
                showToast('请输入修改需求', 'warning');
                return null;
            }

            // 获取当前页面标识
            const currentPageInfo = getCurrentPageInfo();

            // 构建文件路径
            const filePath = `d:\\ai project\\ky_antigravity\\原型生成器\\projects\\${projectId}\\index.html`;

            const elements = selectedElements.map((el, i) => {
                const textContent = (el.innerText || '').trim().slice(0, 50);
                const classNames = el.className && typeof el.className === 'string' ? el.className : '';
                return `### 元素 ${i + 1}
- **CSS 选择器**: \`${generateSelector(el)}\`
- **标签类型**: \`${el.tagName.toLowerCase()}\`
${el.id ? `- **元素 ID**: \`${el.id}\`` : ''}
${classNames ? `- **元素 class**: \`${classNames}\`` : ''}
${textContent ? `- **文本内容**: "${textContent}${(el.innerText || '').length > 50 ? '...' : ''}"` : ''}
- **HTML 片段**:
\`\`\`html
${el.outerHTML}
\`\`\`
`;
            }).join('\n');

            return `# 微调请求

## 目标文件
\`${filePath}\`

## 项目信息
- **项目ID**: ${projectId}
- **当前页面**: ${currentPageInfo}

## 选中元素 (共 ${selectedElements.length} 个)

${elements}

## 修改需求

${userInput}

## 注意事项

- 请打开上述目标文件进行修改
- 请只修改上述选中的元素
- 保持其他代码不变
- 使用 CSS 选择器或搜索 HTML 片段定位元素
- 保持页面整体风格一致
`;
        }

        function copyPrompt() {
            const prompt = generatePrompt();
            if (!prompt) return;

            navigator.clipboard.writeText(prompt).then(() => {
                showToast('Prompt 已复制到剪贴板！');
                closeInspectorModal();
                clearAllSelections();
            }).catch(err => {
                console.error('复制失败:', err);
                // 降级方案：显示文本框让用户手动复制
                const textarea = document.createElement('textarea');
                textarea.value = prompt;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showToast('Prompt 已复制到剪贴板！');
                closeInspectorModal();
                clearAllSelections();
            });
        }

        async function applyWithAI() {
            const prompt = generatePrompt();
            if (!prompt) return;

            const btn = event.target.closest('button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> AI 处理中...';
            btn.disabled = true;

            try {
                const res = await fetch('/api/inspector/apply', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        projectId: projectId,
                        prompt: prompt,
                        elements: selectedElements.map(el => ({
                            selector: generateSelector(el),
                            html: el.outerHTML
                        })),
                        userRequest: $('inspectorInput').value.trim()
                    })
                });

                const data = await res.json();

                if (data.success) {
                    alert('修改成功！页面将自动刷新。');
                    closeInspectorModal();
                    clearAllSelections();
                    // 刷新 iframe
                    previewFrame.src = previewFrame.src;
                } else {
                    alert('修改失败: ' + (data.error || '未知错误'));
                }
            } catch (e) {
                console.error('[Inspector] AI 调用失败:', e);
                alert('AI 接口调用失败，请稍后重试或使用"复制 Prompt"功能手动修改。\n\n错误: ' + e.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // ==================== 页面信息获取 ====================
        function getCurrentPageInfo() {
            try {
                const iframeWin = previewFrame.contentWindow;
                const hash = iframeWin.location.hash;

                // 尝试获取 Vue Router 路由
                if (iframeWin.__VUE_APP__ && iframeWin.__VUE_APP__.$route) {
                    return iframeWin.__VUE_APP__.$route.path || hash || 'home';
                }

                // 检查 Vue 3 应用
                if (iframeWin.app && iframeWin.app.$router) {
                    const route = iframeWin.app.$router.currentRoute.value;
                    if (route && route.path) {
                        return route.path;
                    }
                }

                // 返回 hash 或默认值
                if (hash && hash !== '#' && hash !== '#/') {
                    return hash;
                }
                return 'home (首页)';
            } catch (e) {
                console.log('[getCurrentPageInfo] 获取页面信息失败:', e);
                return 'home';
            }
        }

        // ==================== 整页面修改功能 ====================
        function openFullPageModal() {
            $('fullPageCurrentPage').textContent = getCurrentPageInfo();
            const modal = $('fullPageModal');
            modal.classList.remove('hidden');
            modal.classList.add('active');
            $('fullPageInput').focus();
        }

        function closeFullPageModal() {
            const modal = $('fullPageModal');
            modal.classList.add('hidden');
            modal.classList.remove('active');
            $('fullPageInput').value = '';
        }

        function generateFullPagePrompt() {
            const userInput = $('fullPageInput').value.trim();
            if (!userInput) {
                showToast('请输入修改需求', 'warning');
                return null;
            }

            const filePath = `d:\\ai project\\ky_antigravity\\原型生成器\\projects\\${projectId}\\index.html`;
            const currentPageInfo = getCurrentPageInfo();

            return `# 整页面修改请求

## 目标文件
\`${filePath}\`

## 项目信息
- **项目ID**: ${projectId}
- **当前页面**: ${currentPageInfo}

## 修改需求

${userInput}

## 注意事项

- 这是针对整个页面的修改请求
- 请打开上述目标文件进行修改
- 保持页面整体风格和代码结构一致
- 如使用 Vue Router，注意修改对应路由组件
`;
        }

        function copyFullPagePrompt() {
            const prompt = generateFullPagePrompt();
            if (!prompt) return;

            navigator.clipboard.writeText(prompt).then(() => {
                showToast('整页面 Prompt 已复制到剪贴板！');
                closeFullPageModal();
            }).catch(err => {
                console.error('复制失败:', err);
                const textarea = document.createElement('textarea');
                textarea.value = prompt;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showToast('整页面 Prompt 已复制到剪贴板！');
                closeFullPageModal();
            });
        }

        async function applyFullPageWithAI() {
            const prompt = generateFullPagePrompt();
            if (!prompt) return;

            const btn = event.target.closest('button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> AI 处理中...';
            btn.disabled = true;

            try {
                const res = await fetch('/api/inspector/apply', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        projectId: projectId,
                        prompt: prompt,
                        elements: [],
                        userRequest: $('fullPageInput').value.trim(),
                        isFullPage: true
                    })
                });

                const data = await res.json();

                if (data.success) {
                    alert('修改成功！页面将自动刷新。');
                    closeFullPageModal();
                    previewFrame.src = previewFrame.src;
                } else {
                    alert('修改失败: ' + (data.error || '未知错误'));
                }
            } catch (e) {
                console.error('[FullPage] AI 调用失败:', e);
                alert('AI 接口调用失败，请使用"复制 Prompt"功能手动修改。\n\n错误: ' + e.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // ==================== Modal Drag Logic ====================

        (function initDrag() {
            const modalHeader = document.querySelector('.inspector-modal-header');
            if (modalHeader) {
                let isDraggingModal = false;
                let dragStartX = 0;
                let dragStartY = 0;
                let initialLeft = 0;
                let initialTop = 0;

                modalHeader.addEventListener('mousedown', function (e) {
                    isDraggingModal = true;
                    dragStartX = e.clientX;
                    dragStartY = e.clientY;

                    const modal = document.getElementById('inspectorModal');
                    const rect = modal.getBoundingClientRect();
                    initialLeft = rect.left;
                    initialTop = rect.top;

                    // Switch to manual positioning
                    modal.style.bottom = 'auto';
                    modal.style.right = 'auto';
                    modal.style.left = initialLeft + 'px';
                    modal.style.top = initialTop + 'px';

                    // Add grabbing cursor
                    modalHeader.style.cursor = 'grabbing';
                });

                document.addEventListener('mousemove', function (e) {
                    if (!isDraggingModal) return;
                    e.preventDefault();

                    const dx = e.clientX - dragStartX;
                    const dy = e.clientY - dragStartY;

                    const modal = document.getElementById('inspectorModal');
                    modal.style.left = (initialLeft + dx) + 'px';
                    modal.style.top = (initialTop + dy) + 'px';
                });

                document.addEventListener('mouseup', function (e) {
                    if (isDraggingModal) {
                        isDraggingModal = false;
                        modalHeader.style.cursor = 'move';
                    }
                });
            }
        })();

        // ==================== FullPage Modal Drag Logic ====================
        (function initFullPageDrag() {
            const fullPageModal = document.getElementById('fullPageModal');
            const fullPageHeader = fullPageModal ? fullPageModal.querySelector('.inspector-modal-header') : null;

            if (fullPageHeader) {
                let isDraggingFullPage = false;
                let dragStartX = 0;
                let dragStartY = 0;
                let initialLeft = 0;
                let initialTop = 0;

                fullPageHeader.addEventListener('mousedown', function (e) {
                    // 不拖动按钮
                    if (e.target.closest('button')) return;

                    isDraggingFullPage = true;
                    dragStartX = e.clientX;
                    dragStartY = e.clientY;

                    const rect = fullPageModal.getBoundingClientRect();
                    initialLeft = rect.left;
                    initialTop = rect.top;

                    // Switch to manual positioning
                    fullPageModal.style.bottom = 'auto';
                    fullPageModal.style.right = 'auto';
                    fullPageModal.style.left = initialLeft + 'px';
                    fullPageModal.style.top = initialTop + 'px';

                    fullPageHeader.style.cursor = 'grabbing';
                });

                document.addEventListener('mousemove', function (e) {
                    if (!isDraggingFullPage) return;
                    e.preventDefault();

                    const dx = e.clientX - dragStartX;
                    const dy = e.clientY - dragStartY;

                    fullPageModal.style.left = (initialLeft + dx) + 'px';
                    fullPageModal.style.top = (initialTop + dy) + 'px';
                });

                document.addEventListener('mouseup', function (e) {
                    if (isDraggingFullPage) {
                        isDraggingFullPage = false;
                        fullPageHeader.style.cursor = 'move';
                    }
                });
            }
        })();

        // ==================== Toolbar Drag Logic ====================

        (function initToolbarDrag() {
            const toolbar = document.querySelector('.preview-toolbar-wrapper');
            if (toolbar) {
                let isDragging = false;
                let startX, startY, initialRight, initialTop;

                // Hover Logic
                toolbar.addEventListener('mouseenter', () => {
                    if (!isDragging) toolbar.classList.add('expanded');
                });
                toolbar.addEventListener('mouseleave', () => {
                    if (!isDragging) toolbar.classList.remove('expanded');
                });

                // Drag Logic
                toolbar.addEventListener('mousedown', (e) => {
                    // Prevent drag if clicking interactive elements inside panel
                    if (e.target.closest('button') || e.target.closest('a') || e.target.closest('.view-btn') || e.target.closest('.mode-option')) {
                        return;
                    }

                    isDragging = true;
                    startX = e.clientX;
                    startY = e.clientY;

                    // Get computed style for right/top
                    const computed = window.getComputedStyle(toolbar);
                    initialRight = parseInt(computed.right) || 0;
                    initialTop = parseInt(computed.top) || 0;

                    e.preventDefault();
                    toolbar.style.cursor = 'grabbing';
                });

                document.addEventListener('mousemove', (e) => {
                    if (!isDragging) return;
                    e.preventDefault();

                    const dx = e.clientX - startX;
                    const dy = e.clientY - startY;

                    toolbar.style.right = (initialRight - dx) + 'px';
                    toolbar.style.top = (initialTop + dy) + 'px';
                });

                document.addEventListener('mouseup', () => {
                    if (isDragging) {
                        isDragging = false;
                        toolbar.style.cursor = 'auto';

                        // Re-check hover
                        if (!toolbar.matches(':hover')) {
                            toolbar.classList.remove('expanded');
                        }
                    }
                });
            }
        })();
    </script>
</body>

</html>